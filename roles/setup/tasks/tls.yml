---
- name: Ensure Docker TLS directories exist
  ansible.builtin.file:
    path: "/etc/docker/certs"
    state: "directory"
    mode: 0750

- name: Fetch CA certificate from cfssl
  ansible.builtin.uri:
    url: "{{ cfssl_url }}/api/v1/cfssl/info"
    method: POST
    body_format: json
    body: {}
  register: ca

- name: Generate key/cert pair for server via cfssl API
  ansible.builtin.uri:
    url: "{{ cfssl_url }}/api/v1/cfssl/newcert"
    method: POST
    body_format: json
    body: "{{ lookup('template', docker_csr_template) }}"
  register: cert

- name: Copy certificates to Docker TLS directory
  ansible.builtin.copy:
    dest: "/etc/docker/certs/{{ item.name }}.pem"
    content: "{{ item.content }}"
    mode: "0640"
  loop:
    - { name: "ca", content: "{{ ca.json.result.certificate }}" }
    - { name: "server", content: "{{ cert.json.result.certificate }}" }
    - {
        name: "server-key",
        content: "{{ cert.json.result.private_key }}",
      }
